<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComparisonController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project</a> &gt; <a href="index.source.html" class="el_package">cse364.project</a> &gt; <span class="el_source">ComparisonController.java</span></div><h1>ComparisonController.java</h1><pre class="source lang-java linenums">package cse364.project;

import java.lang.Math;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class ComparisonController {

    private final MovieRepository movieRepository;
    private final UserRepository userRepository;
    private final MovieService movieService;

<span class="fc" id="L20">    public ComparisonController(MovieRepository movieRepository, UserRepository userRepository, MovieService movieService) {</span>
<span class="fc" id="L21">        this.movieRepository = movieRepository;</span>
<span class="fc" id="L22">        this.userRepository = userRepository;</span>
<span class="fc" id="L23">        this.movieService = movieService;</span>
<span class="fc" id="L24">    }</span>

    @PostMapping(&quot;/comparisons&quot;)
    public List&lt;Long&gt; compareMovies(@RequestBody Map&lt;String, Long&gt; requestBody) {
<span class="fc" id="L28">        Long id1 = requestBody.get(&quot;id1&quot;);</span>
<span class="fc" id="L29">        Long id2 = requestBody.get(&quot;id2&quot;);</span>
    
<span class="fc" id="L31">        long current_year = 2024;</span>
        Movie movie1, movie2;

<span class="fc" id="L34">        Optional&lt;Movie&gt; optional1 = movieRepository.findById(id1);</span>
<span class="fc bfc" id="L35" title="All 2 branches covered.">        if (optional1.isPresent()) {</span>
<span class="fc" id="L36">            movie1 = optional1.get();</span>
        } else {
<span class="fc" id="L38">            throw new CannotFoundException(&quot;movie&quot;, id1);</span>
        }

<span class="fc" id="L41">        Optional&lt;Movie&gt; optional2 = movieRepository.findById(id2);</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">        if (optional2.isPresent()) {</span>
<span class="fc" id="L43">            movie2 = optional2.get();</span>
        } else {
<span class="fc" id="L45">            throw new CannotFoundException(&quot;movie&quot;, id2);</span>
        }
        
        // Check how much the movie is outdated.
<span class="fc" id="L49">        String title1 = movie1.getTitle();</span>
<span class="fc" id="L50">        int lastOpenBracketIndex1 = title1.lastIndexOf('(');</span>
<span class="fc" id="L51">        int closeBracketIndex1 = title1.indexOf(')', lastOpenBracketIndex1);</span>

        double howmuchOutdated1;
<span class="fc bfc" id="L54" title="All 4 branches covered.">        if (lastOpenBracketIndex1 != -1 &amp;&amp; closeBracketIndex1 != -1) {</span>
<span class="fc" id="L55">            String numberStr = title1.substring(lastOpenBracketIndex1 + 1, closeBracketIndex1);</span>
            try {
<span class="fc" id="L57">                howmuchOutdated1 = current_year + 1 - Long.parseLong(numberStr);</span>
<span class="fc" id="L58">            } catch (NumberFormatException e) {</span>
<span class="fc" id="L59">                throw new CannotFoundException(&quot;Released year&quot;, id1);</span>
<span class="fc" id="L60">            }</span>
<span class="fc" id="L61">        } else {</span>
<span class="fc" id="L62">            throw new CannotFoundException(&quot;Released year&quot;, id1);</span>
        }

<span class="fc" id="L65">        String title2 = movie2.getTitle();</span>
<span class="fc" id="L66">        int lastOpenBracketIndex2 = title2.lastIndexOf('(');</span>
<span class="fc" id="L67">        int closeBracketIndex2 = title2.indexOf(')', lastOpenBracketIndex2);</span>

        double howmuchOutdated2;
<span class="fc bfc" id="L70" title="All 4 branches covered.">        if (lastOpenBracketIndex2 != -1 &amp;&amp; closeBracketIndex2 != -1) {</span>
<span class="fc" id="L71">            String numberStr = title2.substring(lastOpenBracketIndex2 + 1, closeBracketIndex2);</span>
            try {
<span class="fc" id="L73">                howmuchOutdated2 = current_year + 1 - Long.parseLong(numberStr);</span>
<span class="fc" id="L74">            } catch (NumberFormatException e) {</span>
<span class="fc" id="L75">                throw new CannotFoundException(&quot;Released year&quot;, id2);</span>
<span class="fc" id="L76">            }</span>
<span class="fc" id="L77">        } else {</span>
<span class="fc" id="L78">            throw new CannotFoundException(&quot;Released year&quot;, id2);</span>
        }
        
        
<span class="fc" id="L82">        double weightOutdated1 = 1 + 1 / howmuchOutdated1;</span>
<span class="fc" id="L83">        double weightOutdated2 = 1 + 1 / howmuchOutdated2;</span>

        // Check how much prefered evenly according to gender, age
<span class="fc" id="L86">        List&lt;Long&gt; numList_over_3_1 = movieService.getMovieStats(id1);</span>
<span class="fc" id="L87">        long num_male_1 = numList_over_3_1.get(0);</span>
<span class="fc" id="L88">        long num_female_1 = numList_over_3_1.get(1);</span>
<span class="fc" id="L89">        long num_1_1 = numList_over_3_1.get(2);</span>
<span class="fc" id="L90">        long num_25_1 = numList_over_3_1.get(3);</span>
<span class="fc" id="L91">        long num_35_1 = numList_over_3_1.get(4);</span>
<span class="fc" id="L92">        long num_50_1 = numList_over_3_1.get(5);</span>
<span class="fc" id="L93">        long sum_of_rating_1 = numList_over_3_1.get(6);</span>
<span class="fc" id="L94">        long num_of_rating_1 = numList_over_3_1.get(7);</span>

<span class="fc" id="L96">        List&lt;Long&gt; numList_over_3_2 = movieService.getMovieStats(id2);</span>
<span class="fc" id="L97">        long num_male_2 = numList_over_3_2.get(0);</span>
<span class="fc" id="L98">        long num_female_2 = numList_over_3_2.get(1);</span>
<span class="fc" id="L99">        long num_1_2 = numList_over_3_2.get(2);</span>
<span class="fc" id="L100">        long num_25_2 = numList_over_3_2.get(3);</span>
<span class="fc" id="L101">        long num_35_2 = numList_over_3_2.get(4);</span>
<span class="fc" id="L102">        long num_50_2 = numList_over_3_2.get(5);</span>
<span class="fc" id="L103">        long sum_of_rating_2 = numList_over_3_2.get(6);</span>
<span class="fc" id="L104">        long num_of_rating_2 = numList_over_3_2.get(7);</span>
        
<span class="fc" id="L106">        double avgrating1 = (double) sum_of_rating_1 / (double) (num_of_rating_1 + 1);</span>
<span class="fc" id="L107">        double avgrating2 = (double) sum_of_rating_2 / (double) (num_of_rating_2 + 1);</span>

<span class="fc" id="L109">        long num_male = 0;</span>
<span class="fc" id="L110">        long num_female = 0;</span>
<span class="fc" id="L111">        long num_1 = 0;</span>
<span class="fc" id="L112">        long num_25 = 0;</span>
<span class="fc" id="L113">        long num_35 = 0;</span>
<span class="fc" id="L114">        long num_50 = 0;</span>

<span class="fc" id="L116">        List&lt;User&gt; users = userRepository.findAll();</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">        for (User user : users) {</span>
<span class="fc" id="L118">            String gender = user.getGender();</span>
<span class="fc" id="L119">            int age = user.getAge();</span>

<span class="fc bfc" id="L121" title="All 2 branches covered.">            if (gender != null) {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                if (gender.equals(&quot;M&quot;)) {</span>
<span class="fc" id="L123">                    num_male++;</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">                } else if (gender.equals(&quot;F&quot;)) {</span>
<span class="fc" id="L125">                    num_female++;</span>
                } else {
                    // user post 때만 예외처리 잘하면 여기서 오류날 일은 없을 거 같긴 함
<span class="fc" id="L128">                    throw new InvalidUserException(&quot;Gender&quot;, gender);</span>
                }
            } else {
                // user post 때만 예외처리 잘하면 여기서 오류날 일은 없을 거 같긴 함
<span class="fc" id="L132">                throw new InvalidUserException(&quot;Gender&quot;, gender);</span>
            }

<span class="fc bfc" id="L135" title="All 2 branches covered.">            if (age &gt;= 50) {</span>
<span class="fc" id="L136">                num_50++;</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            } else if (age &gt;= 35) {</span>
<span class="fc" id="L138">                num_35++;</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">            } else if (age &gt;= 25) {</span>
<span class="fc" id="L140">                num_25++;</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">            } else if (age &gt;= 1) {</span>
<span class="fc" id="L142">                num_1++;</span>
            } else {
                // user post 때만 예외처리 잘하면 여기서 오류날 일은 없을 거 같긴 함
<span class="fc" id="L145">                throw new InvalidUserException(&quot;Age&quot;, String.valueOf(age));</span>
            }
<span class="fc" id="L147">        }</span>

<span class="fc" id="L149">        Long num_total_user = num_male + num_female;</span>

<span class="fc" id="L151">        double howmuchPopular1 = num_of_rating_1 / num_total_user;</span>
<span class="fc" id="L152">        double howmuchPopular2 = num_of_rating_2 / num_total_user;</span>

<span class="fc" id="L154">        double weightPopular1 = 1 + 1 / (howmuchPopular1 + 1);</span>
<span class="fc" id="L155">        double weightPopular2 = 1 + 1 / (howmuchPopular2 + 1);</span>

<span class="fc" id="L157">        double ratio_male_1 = (double) num_male_1 / (double) num_male;</span>
<span class="fc" id="L158">        double ratio_female_1 = (double) num_female_1 / (double) num_female;</span>
<span class="fc" id="L159">        double howmuchGender1 = Math.abs(ratio_male_1 - ratio_female_1);</span>
<span class="fc" id="L160">        double ratio_male_2 = (double) num_male_2 / (double) num_male;</span>
<span class="fc" id="L161">        double ratio_female_2 = (double) num_female_2 / (double) num_female;</span>
<span class="fc" id="L162">        double howmuchGender2 = Math.abs(ratio_male_2 - ratio_female_2);</span>

<span class="fc" id="L164">        double weightGender1 = 1 + 1 / (howmuchGender1 + 1);</span>
<span class="fc" id="L165">        double weightGender2 = 1 + 1 / (howmuchGender2 + 1);</span>


<span class="fc" id="L168">        double mean_multiple_4 = num_1 + num_25 + num_35 + num_50;</span>
<span class="fc" id="L169">        double mean = mean_multiple_4 / 4;</span>
<span class="fc" id="L170">        double var = (Math.pow(num_1 - mean, 2) +</span>
<span class="fc" id="L171">                Math.pow(num_25 - mean, 2) +</span>
<span class="fc" id="L172">                Math.pow(num_35 - mean, 2) +</span>
<span class="fc" id="L173">                Math.pow(num_50 - mean, 2)) / 4;</span>
<span class="fc" id="L174">        double std = Math.sqrt(var);</span>

<span class="fc" id="L176">        double mean_multiple_4_1 = num_1_1 + num_25_1 + num_35_1 + num_50_1;</span>
<span class="fc" id="L177">        double mean_1 = mean_multiple_4_1 / 4;</span>
<span class="fc" id="L178">        double var_1 = (Math.pow(num_1_1 - mean_1, 2) +</span>
<span class="fc" id="L179">                Math.pow(num_25_1 - mean_1, 2) +</span>
<span class="fc" id="L180">                Math.pow(num_35_1 - mean_1, 2) +</span>
<span class="fc" id="L181">                Math.pow(num_50_1 - mean_1, 2)) / 4;</span>
<span class="fc" id="L182">        double std_1 = Math.sqrt(var_1);</span>

<span class="fc" id="L184">        double mean_multiple_4_2 = num_1_2 + num_25_2 + num_35_2 + num_50_2;</span>
<span class="fc" id="L185">        double mean_2 = mean_multiple_4_2 / 4;</span>
<span class="fc" id="L186">        double var_2 = (Math.pow(num_1_2 - mean_2, 2) +</span>
<span class="fc" id="L187">                Math.pow(num_25_2 - mean_2, 2) +</span>
<span class="fc" id="L188">                Math.pow(num_35_2 - mean_2, 2) +</span>
<span class="fc" id="L189">                Math.pow(num_50_2 - mean_2, 2)) / 4;</span>
<span class="fc" id="L190">        double std_2 = Math.sqrt(var_2);</span>
    

<span class="fc" id="L193">        double weightMean1 = 1 + (1 / (1 + Math.abs(mean_1 - mean) / mean));</span>
<span class="fc" id="L194">        double weightStd1 = 1 + (1 / (1 + Math.abs(std_1 - std) / std));</span>
<span class="fc" id="L195">        double weightMean2 = 1 + (1 / (1 + Math.abs(mean_2 - mean) / mean));</span>
<span class="fc" id="L196">        double weightStd2 = 1 + (1 / (1 + Math.abs(std_2 - std) / std));</span>

<span class="fc" id="L198">        double weightAge1 = (weightMean1 + weightStd1) / 2;</span>
<span class="fc" id="L199">        double weightAge2 = (weightMean2 + weightStd2) / 2;</span>

<span class="fc" id="L201">        double weightedRating1 = avgrating1 * weightOutdated1 * weightPopular1 * weightGender1 * weightAge1;</span>
<span class="fc" id="L202">        double weightedRating2 = avgrating2 * weightOutdated2 * weightPopular2 * weightGender2 * weightAge2;</span>
        

<span class="fc bfc" id="L205" title="All 2 branches covered.">        long betterMovie = weightedRating1 &gt; weightedRating2 ? id1 : id2;</span>

<span class="fc" id="L207">        List&lt;Long&gt; comparisonResult = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L209">        comparisonResult.add(betterMovie);</span>
<span class="fc" id="L210">        comparisonResult.add((long)-1);</span>
<span class="fc" id="L211">        comparisonResult.addAll(numList_over_3_1);</span>
<span class="fc" id="L212">        comparisonResult.add((long)-1);</span>
<span class="fc" id="L213">        comparisonResult.addAll(numList_over_3_2);</span>
<span class="fc" id="L214">        comparisonResult.add((long)-1);</span>
<span class="fc" id="L215">        comparisonResult.add(num_male);</span>
<span class="fc" id="L216">        comparisonResult.add(num_female);</span>
<span class="fc" id="L217">        comparisonResult.add(num_1);</span>
<span class="fc" id="L218">        comparisonResult.add(num_25);</span>
<span class="fc" id="L219">        comparisonResult.add(num_35);</span>
<span class="fc" id="L220">        comparisonResult.add(num_50);</span>
        
<span class="fc" id="L222">        return comparisonResult;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>